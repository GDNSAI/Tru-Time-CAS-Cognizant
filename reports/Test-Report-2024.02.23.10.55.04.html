const express = require('express');
const bodyParser = require('body-parser');
const Excel = require('exceljs');
const moment = require('moment');
const fs = require('fs');

const app = express();
const port = 3000;

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static('public'));

const excelFilePath = './output.xlsx';

// Function to create an Excel file with headers if it does not exist
async function createExcelFile() {
    const workbook = new Excel.Workbook();
    const worksheet = workbook.addWorksheet('Data');

    const currentDate = moment();
    const datesToUse = getMonthDates(currentDate);

    // Define headers
    let headers = [
        'Associate ID', 'Associate Name', 'Status', 'Productivity', 'Project Name', 
        'Allocation', 'Started On', 'Onshore/Offshore', 'Location', ...datesToUse
    ];

    worksheet.addRow(headers);
    await workbook.xlsx.writeFile(excelFilePath);
    console.log('Excel file created with headers');
}

// Function to get all dates of the current month
function getMonthDates(date) {
    const monthStart = date.clone().startOf('month');
    const monthEnd = date.clone().endOf('month');
    const dates = [];
    let currentDate = monthStart.clone();

    while (currentDate.isSameOrBefore(monthEnd)) {
        dates.push(currentDate.format('DD-MMM'));
        currentDate.add(1, 'day');
    }
    return dates;
}

// Ensure Excel file exists
if (!fs.existsSync(excelFilePath)) {
    createExcelFile();
}

// API to add data to Excel
app.post('/add-data', async (req, res) => {
    const { associate_id, associate_name, status, productivity, project_name, 
            allocation, started_on, onshore_offshore, location, leave_dates } = req.body;
    
    const workbook = new Excel.Workbook();
    await workbook.xlsx.readFile(excelFilePath);
    const worksheet = workbook.getWorksheet('Data');
    
    const datesToUse = getMonthDates(moment());
    const leaveSet = new Set(leave_dates);

    // Prepare row data
    const rowData = [
        associate_id, associate_name, status, productivity, project_name, 
        allocation, started_on, onshore_offshore, location
    ];

    // Fill attendance data
    datesToUse.forEach(date => {
        rowData.push(leaveSet.has(date) ? 'Personal Leave' : 'Present');
    });

    worksheet.addRow(rowData);
    await workbook.xlsx.writeFile(excelFilePath);
    console.log('Data added to Excel file');
    res.send('Data added successfully');
});

// Start the server
app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
});

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="container">
        <h1>Enter Associate Data</h1>
        <form id="data-form">
            <label for="associate_id">Associate ID:</label>
            <input type="text" id="associate_id" name="associate_id" required>

            <label for="associate_name">Associate Name:</label>
            <input type="text" id="associate_name" name="associate_name" required>

            <label for="status">Status:</label>
            <input type="text" id="status" name="status" required>

            <label for="productivity">Productivity:</label>
            <input type="text" id="productivity" name="productivity" required>

            <label for="project_name">Project Name:</label>
            <input type="text" id="project_name" name="project_name" required>

            <label for="allocation">Allocation:</label>
            <input type="text" id="allocation" name="allocation" required>

            <label for="started_on">Started On:</label>
            <input type="date" id="started_on" name="started_on" required>

            <label for="onshore_offshore">Onshore/Offshore:</label>
            <input type="text" id="onshore_offshore" name="onshore_offshore" required>

            <label for="location">Location:</label>
            <input type="text" id="location" name="location" required>

            <label for="leave_dates">Select Leave Dates:</label>
            <input type="text" id="leave_dates" name="leave_dates" multiple>

            <button type="submit">Submit</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="script.js"></script>
</body>
</html>

body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 300px;
}
input, button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
}
button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
}
button:hover {
    background-color: #218838;
}

document.addEventListener('DOMContentLoaded', function () {
    flatpickr("#leave_dates", {
        mode: "multiple",
        dateFormat: "d-M-Y",
    });

    document.getElementById('data-form').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = {};

        formData.forEach((value, key) => {
            if (key === 'leave_dates') {
                if (!data[key]) data[key] = [];
                data[key].push(value);
            } else {
                data[key] = value;
            }
        });

        fetch('/add-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        })
        .then(response => response.text())
        .then(message => alert(message))
        .catch(error => console.error('Error:', error));
    });
});

