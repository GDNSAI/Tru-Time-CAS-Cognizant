const express = require('express');
const bodyParser = require('body-parser');
const XLSX = require('xlsx');
const fs = require('fs');
const path = require('path');

const app = express();
app.use(bodyParser.json());
app.use(express.static('public'));

// Define headers array
const headers = [
    'ESA Project ID', 'ESA Project Name', 'Associate ID', 'Name', 'Designation', 'Location', 
    'On/Off', 'Billable', 'Allocation Start Date', 'Billing Start Date', 'Allocation End Date', 
    'Billing End Date', 'Billing Rate', 'Department', 'Home Manager ID', 'Home Manager Name', 
    'Project POC', 'Status', 'Requisition/SOW Contract Number', 'Z-ID', 'Ally Track', 
    'Sub Track', 'Integrated Project', 'Onsite Only Project', 'Offshore Only Project', 
    'Onsite + Offshore Project', 'Engagement Manager', 'Alternate Engagement Manager', 
    'Director', 'Exec Lead', 'Ally CIO', 'LoB', 'Ally Mail ID', 'Cognizant Email ID'
];

app.post('/submit', (req, res) => {
    const filePath = 'attendance.xlsx';
    let workbook;
    let worksheet;
    let data = [];

    // Read existing file or create new
    if (fs.existsSync(filePath)) {
        workbook = XLSX.readFile(filePath);
        worksheet = workbook.Sheets['EmployeeData'];
        data = XLSX.utils.sheet_to_json(worksheet);
    } else {
        workbook = XLSX.utils.book_new();
        worksheet = XLSX.utils.json_to_sheet([], { header: headers });
        XLSX.utils.book_append_sheet(workbook, worksheet, 'EmployeeData');
    }

    // Process new data
    const newRow = {};
    headers.forEach((header, index) => {
        const field = header.toLowerCase().replace(/[^a-z0-9]+/g, '');
        newRow[header] = req.body[field];
    });

    // Update or add row
    const existingIndex = data.findIndex(row => row['Associate ID'] === newRow['Associate ID']);
    if (existingIndex !== -1) {
        data[existingIndex] = newRow;
    } else {
        data.push(newRow);
    }

    // Write to file
    const newWorksheet = XLSX.utils.json_to_sheet(data, { header: headers });
    workbook.Sheets['EmployeeData'] = newWorksheet;
    XLSX.writeFile(workbook, filePath);

    res.json({ message: 'Data saved successfully!' });
});

app.get('/fetch-data', (req, res) => {
    const { associateId } = req.query;
    const filePath = 'attendance.xlsx';

    if (!fs.existsSync(filePath)) {
        return res.status(404).json({ error: 'File not found' });
    }

    const workbook = XLSX.readFile(filePath);
    const worksheet = workbook.Sheets['EmployeeData'];
    const data = XLSX.utils.sheet_to_json(worksheet);

    const record = data.find(row => row['Associate ID'] == associateId);
    if (!record) return res.status(404).json({ error: 'Record not found' });
    res.json(record);
});

app.listen(3000, () => console.log('Server running on port 3000'));


document.getElementById("editBtn").addEventListener("click", async () => {
    const associateId = document.getElementById("associateId").value;
    
    if (!associateId) {
        alert("Please enter an Associate ID");
        return;
    }

    try {
        const response = await fetch(`/fetch-data?associateId=${associateId}`);
        if (!response.ok) throw new Error('Record not found');
        
        const data = await response.json();
        populateFormData(data);
        alert("Record loaded successfully!");
    } catch (error) {
        console.error("Error:", error);
        alert("Failed to load record");
    }
});

// Modified populateFormData function
function populateFormData(data) {
    const fieldMap = {
        'esaProjectId': 'ESA Project ID',
        'esaProjectName': 'ESA Project Name',
        'associateId': 'Associate ID',
        // Add all other field mappings...
    };

    Object.entries(fieldMap).forEach(([formField, dataField]) => {
        const element = document.getElementById(formField);
        if (element) element.value = data[dataField] || '';
    });
}

// Modified clearForm function
function clearForm() {
    const fields = [
        'esaProjectId', 'esaProjectName', 'associateId', 'name', 'designation', 
        'location', 'onOff', 'billable', 'allocationStartDate', 'billingStartDate',
        'allocationEndDate', 'billingEndDate', 'billingRate', 'department',
        'homeManagerId', 'homeManagerName', 'projectPoc', 'status', 
        'requisitionSowContractNumber', 'zId', 'allyTrack', 'subTrack',
        'integratedProject', 'onsiteOnlyProject', 'offshoreOnlyProject',
        'onsiteOffshoreProject', 'engagementManager', 'alternateEngagementManager',
        'director', 'execLead', 'allyCio', 'lob', 'allyMailId', 'cognizantEmailId'
    ];

    fields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.value = '';
            element.classList.remove("invalid");
            const errorElement = document.getElementById(`${field}Error`);
            if (errorElement) errorElement.textContent = '';
        }
    });
}
