npm install @tensorflow/tfjs @tensorflow-models/qna @tensorflow-models/universal-sentence-encoder

<!-- Add after existing chat HTML -->
<div id="aiChatContainer" class="chat-container">
    <div class="chat-header" onclick="toggleAIChat()">
        <span>AI Assistant</span>
        <span>Ã—</span>
    </div>
    <div class="chat-body" id="aiChatBody"></div>
    <div class="chat-input">
        <input type="text" id="aiChatMessage" placeholder="Ask anything about employees...">
        <button id="sendAIMessage" onclick="sendAIMessage()">Send</button>
    </div>
</div>

/* AI Chat Specific Styles */
#aiChatContainer {
    bottom: 120px;
    right: 20px;
    background: #f0f0f0;
}

.ai-thinking {
    color: #666;
    font-style: italic;
}

.ai-analysis {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 10px;
    margin: 10px 0;
}


// AI Chat Implementation
let aiModel;
let sentenceEncoder;

async function loadAIModels() {
    try {
        const [model, encoder] = await Promise.all([
            tf.autograd.wrap(() => qna.load()),
            tf.autograd.wrap(() => use.load())
        ]);
        aiModel = model;
        sentenceEncoder = encoder;
        console.log('AI models loaded');
    } catch (error) {
        console.error('Error loading AI models:', error);
    }
}

async function sendAIMessage() {
    const input = document.getElementById('aiChatMessage');
    const message = input.value.trim();
    if (!message) return;

    const chatBody = document.getElementById('aiChatBody');
    chatBody.innerHTML += `<div class="user-message">${message}</div>`;
    input.value = '';

    // Show thinking indicator
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'ai-thinking';
    thinkingDiv.textContent = 'Analyzing your question...';
    chatBody.appendChild(thinkingDiv);
    chatBody.scrollTop = chatBody.scrollHeight;

    try {
        // Get employee data context
        const employees = await fetch('/associates').then(r => r.json());
        const context = employees.map(e => 
            `Employee ${e.associateId}: ${e.name} (Status: ${e.status})`
        ).join('\n');

        // Use Q&A model to find relevant information
        const answers = await aiModel.findAnswers(message, context);
        
        thinkingDiv.remove();

        if (answers.length > 0) {
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'ai-analysis';
            analysisDiv.innerHTML = `
                <strong>Analysis:</strong><br>
                ${answers[0].text} (Confidence: ${Math.round(answers[0].score * 100)}%)<br>
                <button onclick="handleAIFollowUp('${message}')">View Full Details</button>
            `;
            chatBody.appendChild(analysisDiv);
        } else {
            chatBody.innerHTML += `<div class="bot-message">I couldn't find relevant information. Can you rephrase your question?</div>`;
        }
    } catch (error) {
        console.error('AI processing error:', error);
        chatBody.innerHTML += `<div class="bot-message">Error processing your request. Please try again.</div>`;
    }
    chatBody.scrollTop = chatBody.scrollHeight;
}

async function handleAIFollowUp(originalQuestion) {
    try {
        // Get semantic similarity for contextual follow-up
        const employees = await fetch('/associates').then(r => r.json());
        const embeddings = await sentenceEncoder.embed(employees.map(e => 
            `Employee ${e.associateId}: ${e.name}, ${e.status}`
        ));
        
        const queryEmbedding = await sentenceEncoder.embed([originalQuestion]);
        const similarity = tf.matMul(queryEmbedding, embeddings, false, true);
        const matches = Array.from(similarity.dataSync())
            .map((score, index) => ({ score, employee: employees[index] }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);

        const chatBody = document.getElementById('aiChatBody');
        chatBody.innerHTML += `
            <div class="bot-message">
                <strong>Top Matches:</strong>
                ${matches.map(m => `
                    <div>${m.employee.name} (ID: ${m.employee.associateId}, 
                    Score: ${Math.round(m.score * 100)}%)</div>
                `).join('')}
            </div>
        `;
    } catch (error) {
        console.error('Follow-up error:', error);
    }
}

// Initialize AI when page loads
window.addEventListener('load', () => {
    loadAIModels();
});
// Add to your server code
app.get('/employee/:id', (req, res) => {
    const { id } = req.params;
    
    // Read Excel file and find employee
    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet2'];
        const data = XLSX.utils.sheet_to_json(worksheet);
        
        const employee = data.find(e => e['Associate ID'].toString() === id);
        if (employee) return res.json(employee);
    }
    
    res.status(404).json({ error: 'Employee not found' });
});
