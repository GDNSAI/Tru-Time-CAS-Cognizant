app.post('/submit', (req, res) => {
    // ... (validation remains same)

    // Read existing data
    let data = [];
    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet2'];
        data = XLSX.utils.sheet_to_json(worksheet);
    }

    // Prepare new row with styling information
    const newRow = {
        ...req.body,
        // Add styling flag for Historic records
        _statusColor: req.body.status === 'Historic' ? 'red' : 'black'
    };

    // Add new row to appropriate position
    if (newRow.status === 'Historic') {
        data.unshift(newRow); // Add to top
    } else {
        data.push(newRow); // Add to bottom
    }

    // Create worksheet with styling information
    const worksheet = XLSX.utils.json_to_sheet(data, { header: headers });
    
    // Add styling for Historic rows (limited xlsx support)
    if (data.some(row => row._statusColor === 'red')) {
        worksheet['!cols'] = headers.map(() => ({ width: 20 }));
        data.forEach((row, index) => {
            if (row._statusColor === 'red') {
                const cellRef = XLSX.utils.encode_cell({ r: index + 1, c: headers.indexOf('Status') });
                worksheet[cellRef].s = { font: { color: { rgb: 'FFFF0000' } } };
            }
        });
    }

    // Write file
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet2');
    XLSX.writeFile(workbook, filePath);

    res.json({ message: 'Data saved successfully!' });
});


document.getElementById("submitBtn").addEventListener("click", async () => {
    if (validateForm()) {
        const data = collectFormData();
        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (response.ok) {
                alert(data.status === 'Historic' 
                    ? "Historic record added to top!" 
                    : "New record added successfully!");
                clearForm();
            } else {
                alert(result.error || "Failed to save data");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to save data");
        }
    } else {
        alert("Please correct the highlighted fields.");
    }
});

document.getElementById('editBtn').addEventListener('click', function (event) {
    event.preventDefault();
    const associateId = document.getElementById('associateId').value;
    
    if (!associateId) {
        alert('Please enter Associate ID');
        return;
    }

    fetch(`/fetch-data?associateId=${associateId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                populateFormData(data);
                // Change status to Current when editing
                document.getElementById('status').value = 'Current';
            }
        })
        .catch(error => console.error('Error:', error));
});
