<!-- Add this to your HTML file before </body> -->
<div id="chatContainer" style="position: fixed; bottom: 20px; right: 20px; width: 350px; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: none;">
    <div id="chatHeader" style="background: #D08CC5; padding: 15px; border-radius: 10px 10px 0 0; cursor: pointer; color: white; font-weight: bold;">
        Ally Assistant
    </div>
    <div id="chatBody" style="height: 400px; overflow-y: auto; padding: 10px;">
        <div class="chat-message bot">Hello! I'm your Ally assistant. How can I help you today?</div>
    </div>
    <div style="padding: 10px; border-top: 1px solid #ddd;">
        <input type="text" id="userInput" placeholder="Type your message..." 
               style="width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
        <button onclick="sendMessage()" style="width: 25%; padding: 8px; background: #D08CC5; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Send
        </button>
    </div>
</div>

<style>
    .chat-message {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
    }
    .user {
        background: #D08CC5;
        color: white;
        margin-left: auto;
    }
    .bot {
        background: #f1f1f1;
        color: #333;
    }
    #chatBody::-webkit-scrollbar {
        width: 5px;
    }
    #chatBody::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    #chatBody::-webkit-scrollbar-thumb {
        background: #D08CC5;
    }
</style>

<script>
    let isChatOpen = false;
    const chatContainer = document.getElementById('chatContainer');
    
    document.getElementById('chatHeader').addEventListener('click', () => {
        isChatOpen = !isChatOpen;
        chatContainer.style.display = isChatOpen ? 'block' : 'none';
    });

    async function sendMessage() {
        const userInput = document.getElementById('userInput');
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message
        const chatBody = document.getElementById('chatBody');
        chatBody.innerHTML += `<div class="chat-message user">${message}</div>`;
        userInput.value = '';
        chatBody.scrollTop = chatBody.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            
            const result = await response.json();
            chatBody.innerHTML += `<div class="chat-message bot">${result.reply}</div>`;
            
            // If data was fetched, display it in the form
            if (result.data) {
                populateFormData(result.data);
                chatBody.innerHTML += `<div class="chat-message bot">Form updated with the requested data!</div>`;
            }
            
            chatBody.scrollTop = chatBody.scrollHeight;
        } catch (error) {
            console.error('Chat error:', error);
            chatBody.innerHTML += `<div class="chat-message bot">Sorry, I encountered an error. Please try again.</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }
</script>

// Add to your server code
const { OpenAI } = require('openai');
const openai = new OpenAI({ apiKey: 'YOUR_OPENAI_API_KEY' });

// Add this endpoint to your Express server
app.post('/chat', async (req, res) => {
    try {
        const { message } = req.body;
        
        // Step 1: Analyze the user's request with OpenAI
        const completion = await openai.chat.completions.create({
            messages: [{
                role: "system",
                content: `You are an intelligent assistant for managing employee data in an Excel sheet. 
                Understand requests and respond with JSON containing: 
                - "action": "fetch" | "update" | "delete" | "add"
                - "criteria": { field: value } for filtering
                - "data": { field: value } for updates/adds
                - "message": human-readable response
                Only respond with valid JSON.`
            }, {
                role: "user",
                content: message
            }],
            model: "gpt-3.5-turbo",
            temperature: 0.1
        });

        const response = JSON.parse(completion.choices[0].message.content);
        
        // Step 2: Perform Excel operation based on AI response
        let result = { reply: response.message };
        
        if (response.action === 'fetch') {
            const data = await fetchExcelData(response.criteria);
            result.data = data[0]; // Return first matching record
        } 
        else if (response.action === 'update') {
            await updateExcelData(response.criteria, response.data);
            result.reply += " Data updated successfully!";
        }
        else if (response.action === 'add') {
            await addExcelRecord(response.data);
            result.reply += " New record added successfully!";
        }

        res.json(result);
    } catch (error) {
        console.error('Chat error:', error);
        res.status(500).json({ reply: "Sorry, I couldn't process that request." });
    }
});

// Helper functions for Excel operations
async function fetchExcelData(criteria) {
    const workbook = XLSX.readFile('attendance.xlsx');
    const data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2']);
    return data.filter(record => 
        Object.entries(criteria).every(([key, value]) => 
            record[key]?.toString().toLowerCase() === value.toLowerCase()
    );
}

async function updateExcelData(criteria, updateData) {
    const workbook = XLSX.readFile('attendance.xlsx');
    const data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2']);
    
    data.forEach(record => {
        if (Object.entries(criteria).every(([key, value]) => 
            record[key]?.toString().toLowerCase() === value.toLowerCase()
        )) {
            Object.assign(record, updateData);
        }
    });
    
    const worksheet = XLSX.utils.json_to_sheet(data);
    workbook.Sheets['Sheet2'] = worksheet;
    XLSX.writeFile(workbook, 'attendance.xlsx');
}

async function addExcelRecord(newData) {
    const workbook = XLSX.readFile('attendance.xlsx');
    const data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2']);
    data.push(newData);
    
    const worksheet = XLSX.utils.json_to_sheet(data);
    workbook.Sheets['Sheet2'] = worksheet;
    XLSX.writeFile(workbook, 'attendance.xlsx');
}
