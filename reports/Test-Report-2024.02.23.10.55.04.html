const express = require('express');
const bodyParser = require('body-parser');
const XLSX = require('xlsx-style'); // Changed to xlsx-style for styling support
const fs = require('fs');

const app = express();
app.use(bodyParser.json());
app.use(express.static('public'));

app.post('/submit', (req, res) => {
    const formData = req.body;
    
    // Validation (keep your existing validation logic)

    const filePath = 'attendance.xlsx';
    let data = [];

    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet2'];
        data = XLSX.utils.sheet_to_json(worksheet);
    }

    // Remove existing entry if present
    const existingIndex = data.findIndex(row => row['Associate ID'] === formData.associateId);
    if (existingIndex !== -1) {
        data.splice(existingIndex, 1);
    }

    // Add new record to appropriate position
    if (formData.status === 'Historic') {
        data.unshift(formData); // Add to top
    } else {
        data.push(formData); // Add to bottom
    }

    // Create worksheet with styles
    const worksheet = XLSX.utils.json_to_sheet(data);
    addHistoricStyles(worksheet, data);

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet2');
    
    // Write file with styles
    XLSX.writeFile(workbook, filePath, { bookType: 'xlsx', cellStyles: true });

    res.json({ message: 'Data saved successfully!' });
});

function addHistoricStyles(worksheet, data) {
    const statusColumnIndex = 17; // Zero-based index of Status column (Q)

    data.forEach((row, index) => {
        if (row.Status === 'Historic') {
            const rowNumber = index + 1; // +1 for header row
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: rowNumber, c: col });
                worksheet[cellAddress].s = {
                    fill: {
                        patternType: 'solid',
                        fgColor: { rgb: 'FFFF0000' },
                        bgColor: { rgb: 'FFFF0000' }
                    }
                };
            }
        }
    });
}

// Keep the rest of your existing server code
