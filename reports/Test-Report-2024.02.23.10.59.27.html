app.post('/submit', (req, res) => {
    // ... existing destructuring ...

    // Validate all required fields
    // ... existing validation ...

    const filePath = 'attendance.xlsx';
    let workbook;
    let worksheet;

    try {
        if (fs.existsSync(filePath)) {
            workbook = XLSX.readFile(filePath);
            worksheet = workbook.Sheets['Sheet2'];
            const data = XLSX.utils.sheet_to_json(worksheet);

            // Check for existing record with same Associate ID and Status
            const duplicate = data.find(row => 
                row['Associate ID'].toString() === associateId.toString() &&
                row['Status'] === status
            );

            if (duplicate) {
                return res.status(409).json({ error: 'Record already exists' });
            }

            // Remove only "Current" records with this Associate ID
            const filteredData = data.filter(row => 
                !(row['Associate ID'].toString() === associateId.toString() && row['Status'] === 'Current')
            );

            // Create new data array
            const newRow = { /* ... existing newRow creation ... */ };

            // Add new row to appropriate position
            const updatedData = status === 'Historic' ? 
                [newRow, ...filteredData] : 
                [...filteredData, newRow];

            // Preserve header formatting by writing to existing sheet
            XLSX.utils.sheet_add_json(worksheet, updatedData, { skipHeader: true, origin: 'A2' });
        } else {
            // Create new workbook with styled headers
            workbook = XLSX.utils.book_new();
            worksheet = XLSX.utils.json_to_sheet([newRow], { header: headers });
            
            // Add header styling
            const headerStyle = {
                fill: { fgColor: { rgb: "D3D3D3" } },
                font: { bold: true },
                alignment: { wrapText: true }
            };
            
            headers.forEach((_, col) => {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
                worksheet[cellRef].s = headerStyle;
            });
            
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet2');
        }

        // Preserve filters
        worksheet['!autofilter'] = { ref: `A1:${XLSX.utils.encode_col(headers.length - 1)}1` };

        XLSX.writeFile(workbook, filePath, { bookSST: true });
        res.json({ message: 'Data saved successfully!' });

    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ error: 'Internal server error' });
    }
});

document.getElementById("submitBtn").addEventListener("click", async () => {
    if (validateForm()) {
        const data = collectFormData();
        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                // ... success handling ...
            } else if (response.status === 409) {
                alert("Record already exists!");
            } else {
                alert(result.error || "Failed to save data");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to save data");
        }
    } else {
        alert("Please correct the highlighted fields.");
    }
});
