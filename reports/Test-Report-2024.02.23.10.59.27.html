const express = require('express');
const bodyParser = require('body-parser');
const XLSX = require('xlsx-js-style');
const fs = require('fs');

const app = express();
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(express.static('public'));

app.post('/submit', (req, res) => {
    // ... validation and field extraction ...

    // Prepare new row without ...req.body and _statusColor
    const newRow = {
        'ESA Project ID': esaProjectId,
        'ESA Project Name': esaProjectName,
        'Associate ID': associateId,
        'Name': name,
        'Designation': designation,
        'Location': location,
        'On/Off': onOff,
        'Billable': billable,
        'Allocation Start Date': allocationStartDate,
        'Billing Start Date': billingStartDate,
        'Allocation End Date': allocationEndDate,
        'Billing End Date': billingEndDate,
        'Billing Rate': billingRate,
        'Department': department,
        'Home Manager ID': homeManagerId,
        'Home Manager Name': homeManagerName,
        'Project POC': projectPoc,
        'Status': status,
        'Requisition/SOW Contract Number': requisitionSowContractNumber,
        'Z-ID': zId,
        'Ally Track': allyTrack,
        'Sub Track': subTrack,
        'Integrated Project': integratedProject,
        'Onsite Only Project': onsiteOnlyProject,
        'Offshore Only Project': offshoreOnlyProject,
        'Onsite + Offshore Project': onsiteOffshoreProject,
        'Engagement Manager': engagementManager,
        'Alternate Engagement Manager': alternateEngagementManager,
        'Director': director,
        'Exec Lead': execLead,
        'Ally CIO': allyCio,
        'LoB': lob,
        'Ally Mail ID': allyMailId,
        'Cognizant Email ID': cognizantEmailId
    };

    // ... rest of data processing ...

    // Update styling logic
    data.forEach((row, index) => {
        if (row['Status'] === 'Historic') {
            headers.forEach((header, colIndex) => {
                const cellRef = XLSX.utils.encode_cell({ r: index + 1, c: colIndex });
                if (!worksheet[cellRef]) worksheet[cellRef] = { v: row[header] };
                worksheet[cellRef].s = { font: { color: { rgb: 'FF0000' } } };
            });
        }
    });

    // ... write to file and send response ...
});

app.get('/fetch-data', (req, res) => {
    // ... fetch logic (no changes needed here) ...
});

app.listen(3000, () => console.log('Server running on port 3000'));
