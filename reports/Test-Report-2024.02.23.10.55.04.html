const express = require('express');
const bodyParser = require('body-parser');
const XLSX = require('xlsx');
const fs = require('fs');

const app = express();
app.use(bodyParser.urlencoded({ extended: true }));

// Serve static files (HTML, CSS, JS)
app.use(express.static('public'));

app.post('/submit', (req, res) => {
    const { associateId, associateName, status, projectId, projectName, allocationStartDate, onshoreOffshore, location, leaveDates, leaveType } = req.body;

    // Validate all required fields
    if (!associateId || !associateName || !status || !projectId || !projectName || !allocationStartDate || !onshoreOffshore || !location || !leaveDates || !leaveType) {
        return res.status(400).json({ error: 'All fields are required' });
    }

    const filePath = 'attandence.xlsx';
    const headers = ['Associate ID', 'Associate Name', 'Status', 'Project ID', 'Project Name', 'Allocation Start Date', 'Onshore/Offshore', 'Location', 'Leave Dates', 'Leave Type'];
    let data = [];

    // Read existing data if the file exists
    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet1'];
        data = XLSX.utils.sheet_to_json(worksheet);
    }

    // Check if the Associate ID already exists
    const existingIndex = data.findIndex(row => row['Associate ID'] === associateId);

    // Prepare the new row data
    const newRow = {
        'Associate ID': associateId,
        'Associate Name': associateName,
        'Status': status,
        'Project ID': projectId,
        'Project Name': projectName,
        'Allocation Start Date': allocationStartDate,
        'Onshore/Offshore': onshoreOffshore,
        'Location': location,
        'Leave Dates': leaveDates,
        'Leave Type': leaveType
    };

    // Update or add the new row
    if (existingIndex !== -1) {
        data[existingIndex] = newRow;
    } else {
        data.push(newRow);
    }

    // Create a new workbook and worksheet
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.json_to_sheet(data, { header: headers });
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
    XLSX.writeFile(workbook, filePath);

    res.json({ message: 'Data saved successfully!' });
});

app.get('/fetch-data', (req, res) => {
    const { associateId, associateName } = req.query;

    const filePath = 'attandence.xlsx';
    if (!fs.existsSync(filePath)) {
        return res.status(404).json({ error: 'File not found' });
    }

    const workbook = XLSX.readFile(filePath);
    const worksheet = workbook.Sheets['Sheet1'];
    const data = XLSX.utils.sheet_to_json(worksheet);

    // Find by Associate ID or Name
    const record = data.find(row => 
        row['Associate ID'] === associateId || 
        row['Associate Name'] === associateName
    );

    if (!record) return res.status(404).json({ error: 'Record not found' });
    res.json(record);
});

app.listen(3000, () => console.log('Server running on port 3000'));



document.getElementById('editBtn').addEventListener('click', function (event) {
    event.preventDefault();
    const associateId = document.getElementById('associateId').value;
    const associateName = document.getElementById('associateName').value;

    if (!associateId && !associateName) {
        alert('Please enter Associate ID or Name');
        return;
    }

    fetch(`/fetch-data?associateId=${associateId}&associateName=${associateName}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                // Populate form fields
                document.getElementById('associateId').value = data['Associate ID'];
                document.getElementById('associateId').readOnly = true; // Make ID read-only
                document.getElementById('associateName').value = data['Associate Name'];
                document.getElementById('status').value = data['Status'];
                document.getElementById('projectId').value = data['Project ID'];
                document.getElementById('projectName').value = data['Project Name'];
                document.getElementById('allocationStartDate').value = data['Allocation Start Date'];
                document.getElementById('onshoreOffshore').value = data['Onshore/Offshore'];
                document.getElementById('location').value = data['Location'];
                document.getElementById('leaveDates').value = data['Leave Dates'];
                document.getElementById('leaveType').value = data['Leave Type'];
            }
        })
        .catch(error => console.error('Error:', error));
});

document.getElementById('submitBtn').addEventListener('click', function (event) {
    event.preventDefault();
    // ... existing validation and submission logic ...
});
