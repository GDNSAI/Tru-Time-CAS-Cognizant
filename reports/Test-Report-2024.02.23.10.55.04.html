document.getElementById('submitBtn').addEventListener('click', function (event) {
    event.preventDefault();
    let isValid = true;
    const fields = [
        { field: document.getElementById('associateId'), errorId: 'associateIdError' },
        { field: document.getElementById('associateName'), errorId: 'associateNameError' },
        { field: document.getElementById('status'), errorId: 'statusError' },
        { field: document.getElementById('projectId'), errorId: 'projectIdError' },
        { field: document.getElementById('projectName'), errorId: 'projectNameError' },
        { field: document.getElementById('allocationStartDate'), errorId: 'allocationStartDateError' },
        { field: document.getElementById('onshoreOffshore'), errorId: 'onshoreOffshoreError' },
        { field: document.getElementById('location'), errorId: 'locationError' },
        { field: document.getElementById('leaveDates'), errorId: 'leaveDatesError' },
        { field: document.getElementById('leaveType'), errorId: 'leaveTypeError' }
    ];

    fields.forEach(({ field, errorId }) => {
        const errorMessage = document.getElementById(errorId);
        if (!field.value) {
            field.classList.add('invalid');
            errorMessage.textContent = 'This field is required';
            isValid = false;
        } else {
            field.classList.remove('invalid');
            errorMessage.textContent = '';
        }
    });

    if (isValid) {
        const formData = {
            associateId: document.getElementById('associateId').value,
            associateName: document.getElementById('associateName').value,
            status: document.getElementById('status').value,
            projectId: document.getElementById('projectId').value,
            projectName: document.getElementById('projectName').value,
            allocationStartDate: document.getElementById('allocationStartDate').value,
            onshoreOffshore: document.getElementById('onshoreOffshore').value,
            location: document.getElementById('location').value,
            leaveDates: document.getElementById('leaveDates').value,
            leaveType: document.getElementById('leaveType').value
        };

        fetch('/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Form submitted successfully!');
                }
            })
            .catch(error => console.error('Error:', error));
    }
});


const express = require('express');
const bodyParser = require('body-parser');
const XLSX = require('xlsx');
const fs = require('fs');
const moment = require('moment');

const app = express();
app.use(bodyParser.urlencoded({ extended: true }));

// Serve static files (HTML, CSS, JS)
app.use(express.static('public'));

app.post('/submit', (req, res) => {
    const { associateName, associateId, status, projectId, projectName, allocationStartDate, onshoreOffshore, location, leaveDates, leaveType } = req.body;

    // Validate all required fields
    if (!associateName || !associateId || !status || !projectId || !projectName || !allocationStartDate || !onshoreOffshore || !location || !leaveDates || !leaveType) {
        return res.status(400).json({ error: 'All fields are required' });
    }

    const filePath = 'attendance.xlsx';
    const headers = ['Associate Name', 'Associate ID', 'Status', 'Project ID', 'Project Name', 'Allocation Start Date', 'Onshore/Offshore', 'Location', 'Leave Dates', 'Leave Type'];
    let data = [];

    // Generate dates and days for the current month
    const currentMonth = moment().format('MMMM YYYY'); // Current month, e.g., "February 2025"
    const startOfMonth = moment().startOf('month');
    const endOfMonth = moment().endOf('month');
    const daysInMonth = [];

    for (let day = startOfMonth; day.isBefore(endOfMonth); day.add(1, 'days')) {
        daysInMonth.push({
            date: day.format('DD-MMM'),
            dayOfWeek: day.format('ddd')
        });
    }

    // Read existing data if the file exists
    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet1'];
        data = XLSX.utils.sheet_to_json(worksheet);
    }

    // Check if the Associate ID already exists
    const existingIndex = data.findIndex(row => row['Associate ID'] === associateId);

    // Prepare the new row data
    const newRow = {
        'Associate Name': associateName,
        'Associate ID': associateId,
        'Status': status,
        'Project ID': projectId,
        'Project Name': projectName,
        'Allocation Start Date': allocationStartDate,
        'Onshore/Offshore': onshoreOffshore,
        'Location': location,
        'Leave Dates': leaveDates,
        'Leave Type': leaveType
    };

    // Generate leave data
    const leaveDatesArray = leaveDates.split(',').map(date => moment(date.trim(), 'YYYY-MM-DD').format('DD-MMM'));
    const leaveMap = new Set(leaveDatesArray);

    const monthStatus = daysInMonth.map(day => {
        if (leaveMap.has(day.date)) {
            return leaveType;  // Apply leave type to the specific leave days
        }
        return status === 'Active' ? 'BLD' : status;  // Default status (BLD or UBL)
    });

    // Append the status data to the newRow
    newRow['Leave Data'] = monthStatus.join(', ');

    // Update or add the new row
    if (existingIndex !== -1) {
        data[existingIndex] = newRow;
    } else {
        data.push(newRow);
    }

    // Create a new workbook and worksheet
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.json_to_sheet(data, { header: headers });
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
    XLSX.writeFile(workbook, filePath);

    res.json({ message: 'Data saved successfully!' });
});

app.listen(3000, () => console.log('Server running on port 3000'));
