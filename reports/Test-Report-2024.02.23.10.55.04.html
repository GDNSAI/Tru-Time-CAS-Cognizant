const express = require('express');
const bodyParser = require('body-parser');
const ExcelJS = require('exceljs');
const path = require('path');
const fs = require('fs');

const app = express();
const port = 3000;

// Create Excel file if not exists
const excelFilePath = path.join(__dirname, 'attendance.xlsx');

async function initializeExcel() {
    if (!fs.existsSync(excelFilePath)) {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Attendance');
        worksheet.columns = [
            { header: 'ID', key: 'id' },
            { header: 'Timestamp', key: 'timestamp' },
            { header: 'Associate ID', key: 'associateId' },
            { header: 'Associate Name', key: 'associateName' },
            { header: 'Status', key: 'status' },
            { header: 'Project ID', key: 'projectId' },
            { header: 'Project Name', key: 'projectName' },
            { header: 'Allocation Start Date', key: 'allocationStartDate' },
            { header: 'Onshore/Offshore', key: 'onshoreOffshore' },
            { header: 'Location', key: 'location' },
            { header: 'Leave Dates', key: 'leaveDates' },
            { header: 'Leave Type', key: 'leaveType' }
        ];
        await workbook.xlsx.writeFile(excelFilePath);
    }
}

initializeExcel().catch(console.error);

app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, 'public')));

app.post('/submit', async (req, res) => {
    try {
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.readFile(excelFilePath);
        const worksheet = workbook.getWorksheet('Attendance');

        // Check for existing associate ID
        const existingRow = worksheet.getRows(1, worksheet.rowCount).find(row => 
            row.getCell('associateId').value === req.body.associateId
        );

        if (existingRow) {
            return res.status(400).json({ 
                error: `Associate ID ${req.body.associateId} already exists!` 
            });
        }

        // Add new entry
        const newRow = {
            id: worksheet.rowCount, // Auto-increment ID
            timestamp: new Date().toISOString(),
            ...req.body
        };

        worksheet.addRow(newRow);
        await workbook.xlsx.writeFile(excelFilePath);

        res.json({ message: 'Data saved successfully!' });
    } catch (error) {
        console.error('Server error:', error);
        res.status(500).json({ error: 'Internal server error' });
    }
});

app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
});
