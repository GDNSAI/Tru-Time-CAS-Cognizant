// Edit Button Handler - Strictly for Current records
document.getElementById('editBtn').addEventListener('click', async () => {
    const associateId = document.getElementById('associateId').value.trim();
    
    if (!associateId) {
        alert('Please enter Associate ID');
        return;
    }

    try {
        const response = await fetch(`/fetch-data?associateId=${encodeURIComponent(associateId)}&status=Current`);
        
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error(`No current record found for ID ${associateId}`);
            }
            throw new Error('Server error');
        }

        const data = await response.json();
        
        // Strict validation
        if (data.associateId.toString() !== associateId || data.status !== 'Current') {
            throw new Error('Invalid record received');
        }

        populateFormData(data);
    } catch (error) {
        alert(error.message);
        clearForm();
    }
});

// Get Button Handler - Respects selected status
document.getElementById('getBtn').addEventListener('click', async () => {
    const associateId = document.getElementById('associateId').value.trim();
    const status = document.getElementById('status').value;

    if (!associateId) {
        alert('Please enter Associate ID');
        return;
    }

    try {
        const response = await fetch(`/fetch-data?associateId=${encodeURIComponent(associateId)}&status=${encodeURIComponent(status)}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error(`No ${status.toLowerCase()} record found for ID ${associateId}`);
            }
            throw new Error('Server error');
        }

        const data = await response.json();
        
        // Validate response matches request
        if (data.associateId.toString() !== associateId || data.status !== status) {
            throw new Error('Data mismatch error');
        }

        populateFormData(data);
    } catch (error) {
        alert(error.message);
        clearForm();
    }
});

app.get('/fetch-data', (req, res) => {
    const { associateId, status } = req.query;

    // Validate inputs
    if (!associateId || !status) {
        return res.status(400).json({ error: 'Missing required parameters' });
    }

    // Normalize inputs
    const cleanId = associateId.toString().trim();
    const cleanStatus = status.trim();

    try {
        const workbook = XLSX.readFile('attendance.xlsx');
        const worksheet = workbook.Sheets['Sheet2'];
        const data = XLSX.utils.sheet_to_json(worksheet);

        // Find exact match with type conversion
        const record = data.find(row => 
            row['Associate ID'].toString().trim() === cleanId &&
            row['Status'].trim() === cleanStatus
        );

        if (!record) {
            return res.status(404).json({ error: 'Record not found' });
        }

        // Filter out internal fields before sending response
        const { _statusColor, ...cleanRecord } = record;
        res.json(cleanRecord);

    } catch (error) {
        console.error('Server error:', error);
        res.status(500).json({ error: 'Internal server error' });
    }
});
