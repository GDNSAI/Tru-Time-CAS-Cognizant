app.post('/submit', (req, res) => {
    const {
        esaProjectId, esaProjectName, associateId, name, designation, location, onOff, billable,
        allocationStartDate, billingStartDate, allocationEndDate, billingEndDate, billingRate, department,
        homeManagerId, homeManagerName, projectPoc, status, requisitionSowContractNumber, zId, allyTrack,
        subTrack, integratedProject, onsiteOnlyProject, offshoreOnlyProject, onsiteOffshoreProject,
        engagementManager, alternateEngagementManager, director, execLead, allyCio, lob, allyMailId,
        cognizantEmailId
    } = req.body;

    // Validate all required fields
    if (!esaProjectId || !esaProjectName || !associateId || !name || !designation || !location || !onOff || !billable ||
        !allocationStartDate || !billingStartDate || !allocationEndDate || !billingEndDate || !billingRate || !department ||
        !homeManagerId || !homeManagerName || !projectPoc || !status || !requisitionSowContractNumber || !zId || !allyTrack ||
        !subTrack || !integratedProject || !onsiteOnlyProject || !offshoreOnlyProject || !onsiteOffshoreProject ||
        !engagementManager || !alternateEngagementManager || !director || !execLead || !lob || !allyMailId || !cognizantEmailId) {
        return res.status(400).json({ error: 'All fields are required' });
    }

    // Date validations
    const allocationStart = new Date(allocationStartDate);
    const allocationEnd = new Date(allocationEndDate);
    if (allocationStart > allocationEnd) {
        return res.status(400).json({ error: 'Allocation Start Date must be before or equal to Allocation End Date' });
    }

    const billingStart = new Date(billingStartDate);
    const billingEnd = new Date(billingEndDate);
    if (billingStart > billingEnd) {
        return res.status(400).json({ error: 'Billing Start Date must be before or equal to Billing End Date' });
    }

    const filePath = 'attendance.xlsx';
    const headers = [/* ... headers array ... */];
    let data = [];

    if (fs.existsSync(filePath)) {
        const workbook = XLSX.readFile(filePath);
        const worksheet = workbook.Sheets['Sheet2'];
        data = XLSX.utils.sheet_to_json(worksheet);

        // Normalize dates in existing data
        data.forEach(row => {
            const dateFields = [
                'Allocation Start Date',
                'Billing Start Date',
                'Allocation End Date',
                'Billing End Date'
            ];
            dateFields.forEach(field => {
                if (row[field]) {
                    if (typeof row[field] === 'number') {
                        const date = new Date((row[field] - 25569) * 86400 * 1000);
                        row[field] = date.toISOString().split('T')[0];
                    } else if (row[field] instanceof Date) {
                        row[field] = row[field].toISOString().split('T')[0];
                    }
                }
            });
        });
    }

    // Create newRow with proper data types
    const newRow = {
        'ESA Project ID': esaProjectId,
        'ESA Project Name': esaProjectName,
        'Associate ID': parseInt(associateId, 10),
        'Name': name,
        'Designation': designation,
        'Location': location,
        'On/Off': onOff,
        'Billable': billable,
        'Allocation Start Date': allocationStartDate,
        'Billing Start Date': billingStartDate,
        'Allocation End Date': allocationEndDate,
        'Billing End Date': billingEndDate,
        'Billing Rate': parseFloat(billingRate),
        'Department': department,
        'Home Manager ID': parseInt(homeManagerId, 10),
        'Home Manager Name': homeManagerName,
        'Project POC': projectPoc,
        'Status': status,
        'Requisition/SOW Contract Number': requisitionSowContractNumber,
        'Z-ID': zId,
        'Ally Track': allyTrack,
        'Sub Track': subTrack,
        'Integrated Project': integratedProject,
        'Onsite Only Project': onsiteOnlyProject,
        'Offshore Only Project': offshoreOnlyProject,
        'Onsite + Offshore Project': onsiteOffshoreProject,
        'Engagement Manager': engagementManager,
        'Alternate Engagement Manager': alternateEngagementManager,
        'Director': director,
        'Exec Lead': execLead,
        'Ally CIO': allyCio,
        'LoB': lob,
        'Ally Mail ID': allyMailId,
        'Cognizant Email ID': cognizantEmailId
    };

    // Check for duplicate record
    const isDuplicate = data.some(existingRow => {
        return Object.keys(newRow).every(key => {
            const existingValue = existingRow[key];
            const newValue = newRow[key];
            return JSON.stringify(existingValue) === JSON.stringify(newValue);
        });
    });

    if (isDuplicate) {
        return res.status(400).json({ error: 'This record already exists. No changes made.' });
    }

    // Remove only "Current" records with this Associate ID
    data = data.filter(row => !(row['Associate ID'] === newRow['Associate ID'] && row['Status'] === 'Current'));

    // Add new row to appropriate position
    if (newRow.Status === 'Historic') {
        data.unshift(newRow);
    } else {
        data.push(newRow);
    }

    // ... rest of the code to write to Excel ...
});
