.autocomplete-suggestions {
    position: absolute;
    border: 1px solid #d4d4d4;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
    background: white;
}

.autocomplete-suggestion {
    padding: 8px;
    cursor: pointer;
    background-color: #fff; 
    border-bottom: 1px solid #d4d4d4; 
}

.autocomplete-suggestion:hover {
    background-color: #e9e9e9;
}


<div class="form-group">
    <label for="associateId">Associate ID:</label>
    <input type="number" id="associateId" placeholder="4165772" required>
    <div id="associateSuggestions" class="autocomplete-suggestions"></div>
    <div class="error-message" id="associateIdError"></div>
</div>


// Autocomplete functionality
let currentTimeout;
document.getElementById('associateId').addEventListener('input', function(e) {
    clearTimeout(currentTimeout);
    const input = e.target.value.trim();
    
    if(input.length < 1) {
        document.getElementById('associateSuggestions').innerHTML = '';
        return;
    }
    
    currentTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/search-associates?q=${encodeURIComponent(input)}`);
            const data = await response.json();
            
            const suggestionsHTML = data.map(item => `
                <div class="autocomplete-suggestion" 
                     data-id="${item.associateId}"
                     data-name="${item.name}">
                    ${item.associateId} - ${item.name}
                </div>
            `).join('');
            
            document.getElementById('associateSuggestions').innerHTML = suggestionsHTML;
        } catch (error) {
            console.error('Error fetching suggestions:', error);
        }
    }, 300);
});

// Handle suggestion selection
document.getElementById('associateSuggestions').addEventListener('click', function(e) {
    const suggestion = e.target.closest('.autocomplete-suggestion');
    if(suggestion) {
        const associateId = suggestion.dataset.id;
        document.getElementById('associateId').value = associateId;
        this.innerHTML = '';
        // Auto-fill the form if we have the data
        if(suggestion.dataset.name) {
            document.getElementById('name').value = suggestion.dataset.name;
        }
    }
});

// Close suggestions when clicking outside
document.addEventListener('click', function(e) {
    if(!e.target.closest('#associateSuggestions') && 
       !e.target.matches('#associateId')) {
        document.getElementById('associateSuggestions').innerHTML = '';
    }
});

// Modified submit handler with duplicate check
document.getElementById("submitBtn").addEventListener("click", async () => {
    if(validateForm()) {
        const data = collectFormData();
        
        // Check for existing current record
        try {
            const checkResponse = await fetch(`/check-existing?associateId=${data.associateId}&status=Current`);
            const existing = await checkResponse.json();
            
            if(existing.exists && data.status === 'Current') {
                alert('A current record for this Associate ID already exists!');
                return;
            }
        } catch(error) {
            console.error('Error checking existing record:', error);
        }
        
        // Proceed with submission
        try {
            const response = await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if(response.ok) {
                alert(data.status === 'Historic' 
                    ? "Historic record added to top!" 
                    : "New record added successfully!");
                clearForm();
            } else {
                alert(result.error || "Failed to save data");
            }
        } catch(error) {
            console.error("Error:", error);
            alert("Failed to save data");
        }
    } else {
        alert("Please correct the highlighted fields.");
    }
});

// New endpoint for checking existing records
app.get('/check-existing', (req, res) => {
    const { associateId, status } = req.query;
    
    try {
        const workbook = XLSX.readFile('attendance.xlsx');
        const worksheet = workbook.Sheets['Sheet2'];
        const data = XLSX.utils.sheet_to_json(worksheet);
        
        const exists = data.some(row => 
            row['Associate ID'].toString() === associateId && 
            row['Status'] === status
        );
        
        res.json({ exists });
    } catch(error) {
        console.error(error);
        res.status(500).json({ error: 'Error checking records' });
    }
});

// New endpoint for search suggestions
app.get('/search-associates', (req, res) => {
    const { q } = req.query;
    
    try {
        const workbook = XLSX.readFile('attendance.xlsx');
        const worksheet = workbook.Sheets['Sheet2'];
        const data = XLSX.utils.sheet_to_json(worksheet);
        
        const results = data.filter(row => 
            row['Associate ID'].toString().includes(q) ||
            row['Name'].toLowerCase().includes(q.toLowerCase())
        ).map(row => ({
            associateId: row['Associate ID'],
            name: row['Name']
        }));
        
        res.json(results);
    } catch(error) {
        console.error(error);
        res.status(500).json({ error: 'Error searching records' });
    }
});

        
        
