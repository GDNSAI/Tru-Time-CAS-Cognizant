app.get('/fetch-data', (req, res) => {
    const { associateId, status } = req.query;

    if (!associateId || !status) {
        return res.status(400).json({ error: 'Missing required parameters' });
    }

    try {
        const workbook = XLSX.readFile('attendance.xlsx');
        const worksheet = workbook.Sheets['Sheet2'];
        const data = XLSX.utils.sheet_to_json(worksheet);

        // Map Excel column names to form field names
        const fieldMap = {
            'ESA Project ID': 'esaProjectId',
            'ESA Project Name': 'esaProjectName',
            'Associate ID': 'associateId',
            'Name': 'name',
            'Designation': 'designation',
            'Location': 'location',
            'On/Off': 'onOff',
            'Billable': 'billable',
            'Allocation Start Date': 'allocationStartDate',
            'Billing Start Date': 'billingStartDate',
            'Allocation End Date': 'allocationEndDate',
            'Billing End Date': 'billingEndDate',
            'Billing Rate': 'billingRate',
            'Department': 'department',
            'Home Manager ID': 'homeManagerId',
            'Home Manager Name': 'homeManagerName',
            'Project POC': 'projectPoc',
            'Status': 'status',
            'Requisition/SOW Contract Number': 'requisitionSowContractNumber',
            'Z-ID': 'zId',
            'Ally Track': 'allyTrack',
            'Sub Track': 'subTrack',
            'Integrated Project': 'integratedProject',
            'Onsite Only Project': 'onsiteOnlyProject',
            'Offshore Only Project': 'offshoreOnlyProject',
            'Onsite + Offshore Project': 'onsiteOffshoreProject',
            'Engagement Manager': 'engagementManager',
            'Alternate Engagement Manager': 'alternateEngagementManager',
            'Director': 'director',
            'Exec Lead': 'execLead',
            'Ally CIO': 'allyCio',
            'LoB': 'lob',
            'Ally Mail ID': 'allyMailId',
            'Cognizant Email ID': 'cognizantEmailId'
        };

        const record = data.find(row => 
            row['Associate ID'].toString().trim() === associateId.toString().trim() &&
            row['Status'].trim().toLowerCase() === status.toLowerCase().trim()
        );

        if (!record) {
            return res.status(404).json({ error: 'Record not found' });
        }

        // Map Excel columns to form fields
        const mappedRecord = {};
        Object.entries(record).forEach(([excelKey, value]) => {
            const formField = fieldMap[excelKey];
            if (formField) {
                mappedRecord[formField] = value;
            }
        });

        res.json(mappedRecord);
    } catch (error) {
        console.error('Server error:', error);
        res.status(500).json({ error: 'Internal server error' });
    }
});


function populateFormData(data) {
    const fields = getFormFields();
    fields.forEach((field) => {
        const element = document.getElementById(field);
        if (element) {
            // Handle select elements
            if (element.tagName === 'SELECT') {
                const option = Array.from(element.options).find(
                    opt => opt.value === data[field]
                );
                if (option) {
                    option.selected = true;
                } else {
                    console.warn(`Option not found for ${field}:`, data[field]);
                }
            } 
            // Handle date inputs
            else if (element.type === 'date') {
                element.value = data[field] ? formatDate(data[field]) : '';
            }
            // Handle all other inputs
            else {
                element.value = data[field] || '';
            }
        }
    });
}

// Helper function to format Excel dates
function formatDate(excelDate) {
    if (typeof excelDate === 'number') {
        // Convert Excel serial date to JS Date
        const utcDays = Math.floor(excelDate - 25569);
        const utcValue = utcDays * 86400 * 1000;
        const date = new Date(utcValue);
        return date.toISOString().split('T')[0];
    }
    return excelDate; // Return as-is if already string
}
