// In POST /submit handler
const isDuplicate = data.some(existingRow => 
    Object.keys(newRow).every(key => existingRow[key] === newRow[key])
);

if (isDuplicate) {
    return res.status(400).json({ error: 'This entry already exists!' });
}


// Modify worksheet styling logic
data.forEach((row, index) => {
    if (row.Status === 'Historic') { // Use actual status value
        headers.forEach((header, colIndex) => {
            const cellRef = XLSX.utils.encode_cell({ r: index+1, c: colIndex });
            worksheet[cellRef].s = { 
                font: { color: { rgb: 'FF0000' }, bold: true 
            };
        });
    }
});

// Add duplicate check before submission
document.getElementById("submitBtn").addEventListener("click", async () => {
    const data = collectFormData();
    
    // Check for duplicates
    const checkDup = await fetch('/check-duplicate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    
    if (await checkDup.json().isDuplicate) {
        alert('This exact entry already exists!');
        return;
    }
    
    // Continue with submission...
});

app.post('/check-duplicate', (req, res) => {
    const workbook = XLSX.readFile('attendance.xlsx');
    const data = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2']);
    
    const isDuplicate = data.some(row =>
        Object.keys(req.body).every(key => row[key] === req.body[key])
    );
    
    res.json({ isDuplicate });
});
